---
import AccentedTitleLayout from "@/layouts/AccentedTitleLayout.astro";
import BlogPostTOC from "@/components/BlogPostTOC.astro";
import LocalizedDate from "@/components/LocalizedDate.astro";
import CommonSEO from "@/components/CommonSEO.astro";

import { getBlogPostPath } from "@/lib/blog";
import { type CollectionEntry, getCollection, render } from "astro:content";

export interface Props {
    post: CollectionEntry<"blog" | "notes">;
}

const { post } = Astro.props;
const { Content, headings } = await render(post);
const isBlog = post.collection === "blog";

// Get all posts, sorted by date in increasing order
const allPosts = isBlog
    ? (await getCollection("blog")).toSorted(
          (a, b) => a.data.date.getTime() - b.data.date.getTime(),
      )
    : sortNotesByCategoryThenTitle(await getCollection("notes"));
const thisPostIndex = allPosts.findIndex((p) => p.id === post.id);
const prevPost = allPosts[thisPostIndex - 1];
const nextPost = allPosts[thisPostIndex + 1];

function sortNotesByCategoryThenTitle(
    notes: CollectionEntry<"notes">[],
): CollectionEntry<"notes">[] {
    const category = (note: CollectionEntry<"notes">) =>
        note.filePath!.split("/").at(-2)!;
    return notes.toSorted((a, b) =>
        category(a) !== category(b)
            ? category(a).localeCompare(category(b))
            : a.data.title.localeCompare(b.data.title),
    );
}

function getPostPath(post: CollectionEntry<"blog" | "notes">): string {
    return post.collection === "blog"
        ? getBlogPostPath(post)
        : `/notes/${post.id}/`;
}
---

<AccentedTitleLayout>
    <CommonSEO
        slot="head"
        titleTemplate={"Kian's " + post.collection}
        title={post.data.title}
        description={post.data.description}
        cardTitle={post.data.title}
        article={{
            pubDate: isBlog ? post.data.date : undefined,
        }}
    />

    <div slot="title" class="*:not-first:mt-4 *:not-first:lg:mt-8">
        <div>
            <a class="hover:underline" href={isBlog ? "/blog/" : "/notes/"}>
                &LeftArrow;&nbsp;&nbsp;All {isBlog ? "posts" : "notes"}
            </a>
        </div>
        <div class="text-4xl font-black text-shadow-xs sm:text-6xl">
            {post.data.title}
        </div>
        {
            isBlog && (
                <div class="flex justify-between">
                    <div>{post.data.author}</div>
                    <div>
                        <LocalizedDate
                            style="locale-long"
                            date={post.data.date}
                            utc
                        />
                    </div>
                </div>
            )
        }
    </div>

    <div
        class="prose sm:prose-lg prose-stone prose-headings:underline prose-headings:decoration-accent prose-headings:decoration-4 prose-headings:tracking-tight prose-h1:decoration-6 prose-h1:mt-12 prose-h1:mb-4 prose-a:decoration-accent prose-a:decoration-2 prose-a:hover:decoration-3 prose-code:before:content-none prose-code:after:content-none text-primary mx-auto mt-12 w-full max-w-[75ch] px-8 sm:leading-normal lg:mt-16 [&>section.footnotes]:mt-16 [&>section.footnotes]:border-t [&>section.footnotes]:pt-12"
    >
        {
            isBlog && post.data.toc !== "none" && headings.length > 0 && (
                <BlogPostTOC open={post.data.toc === "expand"} {headings} />
            )
        }
        <Content />
    </div>

    {/* Previous/next post links */}
    <div class="bg-accent text-background mt-16 w-full p-8 shadow-lg">
        <div
            class="mx-auto grid max-w-screen-lg grid-cols-1 gap-8 sm:grid-cols-2 sm:flex-row lg:grid-cols-3"
        >
            {
                [prevPost, nextPost].map((p) => (
                    <div class:list={[p === nextPost && "lg:col-3"]}>
                        {p && (
                            <a
                                class:list={[
                                    "hover:underline",
                                    p === nextPost && "text-right",
                                ]}
                                href={getPostPath(p)}
                            >
                                <div class="text-xl font-bold decoration-2">
                                    {p === prevPost ? (
                                        <>
                                            &LeftArrow;&nbsp;&nbsp;Previous{" "}
                                            {isBlog ? "post" : "note"}
                                        </>
                                    ) : (
                                        <>
                                            Next {isBlog ? "post" : "note"}
                                            &nbsp;&nbsp;&RightArrow;
                                        </>
                                    )}
                                </div>
                                <div>{p.data.title}</div>
                            </a>
                        )}
                    </div>
                ))
            }
        </div>
    </div>
</AccentedTitleLayout>

<style is:global>
    .prose :is(h1, h2, h3, h4, h5, h6) {
        & {
            scroll-margin-top: 3rem;
        }

        & > a {
            & {
                position: relative;
            }

            &::before {
                content: "#";
                position: absolute;
                transform: translateX(-100%);
                color: var(--color-secondary);
                visibility: hidden;
                padding-right: 0.5rem;
                font-weight: bold;
            }

            &:hover::before {
                visibility: visible;
            }
        }
    }
</style>
